<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictado Verde - 500 Palabras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: radial-gradient(circle, #f0fdf4 0%, #dcfce7 100%);
            overflow: hidden;
        }
        .input-word {
            font-size: 3.5rem;
            text-align: center;
            border-bottom: 5px solid #10b981;
            color: #065f46;
            transition: all 0.3s;
        }
        .firecracker {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }
        #thumbs-down {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 150px;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #thumbs-down.active {
            display: block;
            transform: translate(-50%, -50%) scale(1);
        }
        @keyframes particle {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tw-x), var(--tw-y)); opacity: 0; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="thumbs-down">üëé</div>

    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-2xl space-y-6 relative border-4 border-emerald-100">
        
        <!-- Contador en Tonos Verdes -->
        <div class="flex justify-between items-center">
            <div class="bg-emerald-600 text-white px-6 py-2 rounded-full font-bold shadow-md text-lg">
                Palabra: <span id="current-count">1</span> / 500
            </div>
            <div class="text-emerald-500 font-bold text-sm uppercase tracking-widest">
                Bosque de Palabras üå≥
            </div>
        </div>

        <div class="text-center space-y-8">
            <!-- Bot√≥n de Play en Verde -->
            <button id="play-button" 
                    class="group relative bg-emerald-500 hover:bg-emerald-600 text-white p-10 rounded-full shadow-[0_12px_0_0_rgba(5,150,105,1)] active:shadow-none active:translate-y-3 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-emerald-500 rounded-full hidden">
                    <div class="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
            </button>

            <div class="pt-4">
                <input type="text" id="word-input" 
                       class="input-word w-full bg-transparent focus:outline-none placeholder-emerald-100" 
                       placeholder="Escribe la palabra..."
                       autocomplete="off" 
                       spellcheck="false">
                <p class="text-emerald-400 mt-4 font-bold italic">¬°Escucha y escribe!</p>
            </div>
        </div>

        <button id="next-button" 
                class="hidden w-full py-4 bg-green-600 text-white text-2xl font-bold rounded-2xl shadow-[0_8px_0_0_rgba(21,128,61,1)] hover:bg-green-700 transition-all">
            ¬°Muy bien! Siguiente ‚ûî
        </button>
    </div>

    <script type="module">
        const wordBank = [
            "blusa", "brazo", "clase", "clavo", "crema", "crudo", "drag√≥n", "dril", "fresa", "fruta", "flaco", "flota", "globo", "glaciar", "gratis", "gruta", "pluma", "plato", "primo", "presa", "trigo", "tren", "atleta", "tabla", "libro", "sobre", "cerca", "arco", "alto", "azul", "isla", "antes", "diez", "nariz", "luz", "pobre", "pueblo", "cobre", "brillo", "broche", "clima", "chicle", "claxon", "flecha", "flojo", "flauta", "glicerina", "regla", "siglo", "pleno", "soplo", "planta", "precio", "pronto", "prueba", "truco", "potro", "trapo", "trama", "triunfo", "broma", "bruma", "bravo", "bloque", "blanco", "clavel", "cl√≠nica", "cloro", "cr√°neo", "creer", "cristal", "cromo", "crujir", "drama", "drenar", "droga", "dr√°stico", "frase", "freno", "frotar", "fresco", "fruncir", "flama", "fleco", "fluir", "fl√∫or", "grado", "grano", "grito", "groso", "grupo", "pradera", "predio", "prisa", "proa", "prudente", "traje", "tregua", "tr√≠o", "trozo", "trucha",
            "abeja", "abra", "abril", "√°caro", "actriz", "aduana", "afrecho", "aflojar", "agrado", "agrio", "agrupar", "aguja", "ahora", "ajedrez", "alarma", "alberca", "alcalde", "alcoba", "aldea", "alegre", "alfombra", "algo", "alguien", "alguna", "aliento", "alivio", "alma", "almeja", "altar", "altura", "alumno", "alzar", "amable", "amar", "√°mbar", "amigo", "ancla", "anclar", "andar", "and√©n", "√°ngel", "√°ngulo", "anillo", "√°nodo", "ante", "antojo", "anual", "anuncio", "anzuelo", "a√±adir", "apelar", "aplauso", "aprender", "aprisa", "aprobar", "aptitud", "√°rabe", "arado", "ara√±a", "√°rbitro", "√°rbol", "arbusto", "arcilla", "ardilla", "arduo", "arena", "arete", "arma", "armar", "armon√≠a", "aroma", "arpa", "arreglar", "arriba", "arroz", "arruga", "asado", "asaltar", "ascenso", "asco", "aseo", "asfalto", "asfixia", "asilo", "asistir", "asno", "asomar", "asombro", "aspa", "asta", "astro", "asunto", "asustar", "atado", "atajo", "atril", "atril", "at√∫n", "audaz", "aula", "aumento", "aun", "ausente", "auto", "aval", "avance", "avaro", "avena", "avi√≥n", "aviso", "avispa", "ayer", "ayuda", "ayunar", "azafr√°n", "azar", "azteca", "az√∫car", "azufre", "azulejo", "baba", "bacalao", "bachiller", "bacilo", "bad√©n", "bagaje", "bagre", "bah√≠a", "baile", "bajar", "bajel", "balada", "balance", "balanza", "balc√≥n", "baldosa", "bal√≥n", "balsa", "baluarte", "bamb√∫", "banal", "banco", "banda", "bandera", "banquete", "ba√±ar", "ba√±o", "barato", "barba", "barca", "barco", "barrer", "barril", "barrio", "barro", "basalto", "base", "basura", "batalla", "batata", "batir", "ba√∫l", "bazar", "beb√©", "beber", "beca", "bedel", "bejuco", "bello", "bendito", "beneficio", "beso", "bestia", "bet√∫n", "biblia", "bicho", "bien", "bifocal", "bigote", "billete", "bill√≥n", "binario", "biombo", "bisabuelo", "bisagra", "bisonte", "bistur√≠", "bit√°cora", "blanco", "blando", "blandura", "blas√≥n", "blonda", "bloque", "blusa", "bobina", "bobo", "boca", "bocina", "boda", "bodega", "bofetada", "boga", "bola", "bolillo", "bolsa", "bolsillo", "bomba", "bombilla", "bomb√≥n", "bondad", "bonito", "bono", "boquete", "borde", "bordo", "borrachera", "borrador", "borrar", "borrego", "bosque", "bota", "botella", "bot√≠n", "bot√≥n", "b√≥veda", "boxeo", "bozo", "braga", "bramido", "brasa", "bravo", "brazo", "brea", "brecha", "breve", "brezo", "brida", "brillante", "brillar", "brillo", "brindis", "brisa", "broca", "broche", "broma", "bronce", "brota", "broto", "bruja", "br√∫jula", "bruma", "brusco", "brutal", "bruto", "buceo", "buche", "bucle", "buen", "bueno", "buey", "bufanda", "bufete", "buf√≥n", "b√∫ho", "buitre", "buj√≠a", "bulto", "buque", "burbuja", "burla", "burlar", "burro", "buscar", "butaca", "buz√≥n", "caballero", "caballo", "caba√±a", "cabeza", "cabo", "cabra", "cacao", "cacho", "cada", "cadena", "cadera", "cadete", "caer", "caf√©", "ca√≠da", "caja", "caj√≥n", "cala", "calambre", "calamar", "calavera", "calcio", "caldo", "calentura", "calibre", "c√°liz", "calle", "calma", "calmar", "calor", "calumnia", "calvo", "calzado", "calzar", "cama", "camada", "camale√≥n", "c√°mara", "camar√≥n", "camilla", "caminar", "camino", "cami√≥n", "camisa", "camote", "campa", "campana", "campe√≥n", "campo", "canal", "canasta", "cancel", "canci√≥n", "candado", "candil", "canela", "cangrejo", "canica", "canino", "canje", "canoa", "canon", "cansado", "cantar", "c√°ntico", "canto", "ca√±a", "ca√±√≥n", "caoba", "capa", "capaz", "capilla", "capital", "capit√°n", "cap√≠tulo", "cap√≥", "capote", "capullo", "cara", "caracol", "car√°cter", "carb√≥n", "c√°rcel", "cardumen", "careta", "carga", "cargar", "cargo", "caricia", "cari√±o", "carm√≠n", "carne", "carn√©", "carnicero", "caro", "carpa", "carpeta", "carrera", "carretera", "carretilla", "carril", "carrito", "carro", "carruaje", "carta", "cartel", "cartera", "cart√≥n", "cartucho", "casa", "cascada", "casco", "casero", "casi", "casilla", "casino", "caso", "caspa", "casta", "casta√±a", "castillo", "casto", "castrar", "catar", "cat√°strofe", "cauce", "causa", "cautivo", "cavar", "caverna", "caza", "cazar", "ceba", "cebolla", "ceda", "ceder", "cedro", "ceja", "celda", "c√©lebre", "celeste", "celo", "c√©lula", "cementerio", "cena", "cenar", "ceniza", "censo", "centavo", "centena", "central", "centro", "cepillo", "cepo", "cera", "cerca", "cerco", "cerda", "cerdo", "cereza", "cerilla", "cero", "cerrar", "cerro", "cerrojo", "certamen", "cerveza", "c√©sped", "cesta", "cesto", "cetro", "chacal", "chapa", "chaqueta", "charco", "charla", "chasis", "chico", "chiste", "choque", "chorro", "choza", "chulo", "chupar", "ciclo", "ciego", "cielo", "cien", "ci√©naga", "cierre", "cierto", "cifra", "cigarro", "cima", "cincel", "cinco", "cinta", "cintura", "cipr√©s", "circo", "cirio", "ciruela", "cisne", "cita", "citar", "ciudad", "civil", "clamor", "clara", "claro", "clase", "clausura", "clavel", "clavo", "clero", "clich√©", "cliente", "clima", "cl√≠nica", "cloro", "clavo"
        ];

        const apiKey = ""; 
        let currentIndex = 0;
        let currentWord = "";
        let audioBlob = null;
        let userInteracted = false;

        const playBtn = document.getElementById('play-button');
        const loader = document.getElementById('loader');
        const wordInput = document.getElementById('word-input');
        const nextBtn = document.getElementById('next-button');
        const countDisplay = document.getElementById('current-count');
        const thumbsDown = document.getElementById('thumbs-down');

        // --- ANIMACI√ìN FUEGOS ARTIFICIALES (EN VERDE) ---
        function createFirecracker(x, y) {
            const colors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#059669', '#ffffff'];
            for (let i = 0; i < 35; i++) {
                const p = document.createElement('div');
                p.className = 'firecracker';
                const color = colors[Math.floor(Math.random() * colors.length)];
                p.style.backgroundColor = color;
                p.style.boxShadow = `0 0 12px ${color}`;
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 250 + 50;
                const tx = Math.cos(angle) * dist;
                const ty = Math.sin(angle) * dist;
                p.style.setProperty('--tw-x', `${tx}px`);
                p.style.setProperty('--tw-y', `${ty}px`);
                p.style.left = `${x}px`;
                p.style.top = `${y}px`;
                p.style.animation = `particle 0.9s cubic-bezier(0, .5, .5, 1) forwards`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        async function playFirecrackersSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') await ctx.resume();
            
            for(let j=0; j<6; j++) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(200, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                    createFirecracker(Math.random() * window.innerWidth, Math.random() * window.innerHeight);
                }, j * 120);
            }
        }

        // --- TTS UTILS ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const writeString = (off, s) => { for (let i = 0; i < s.length; i++) view.setUint8(off + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            for (let i = 0; i < pcm16.length; i++) view.setInt16(44 + (i * 2), pcm16[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function fetchAudio(word) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `Dime la palabra: ${word}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("TTS Error");
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData;
            if (!part) return null;
            
            const sampleRate = parseInt(part.mimeType.match(/rate=(\d+)/)?.[1] || "16000", 10);
            return pcmToWav(base64ToArrayBuffer(part.data), sampleRate);
        }

        async function playCurrentWord() {
            userInteracted = true;
            if (!audioBlob) return;
            const audio = new Audio(URL.createObjectURL(audioBlob));
            try {
                await audio.play();
            } catch (e) {
                console.warn("Audio bloqueado. Haz clic en la pantalla.");
            }
        }

        // --- L√ìGICA DE CARGA ---
        async function loadWord(shouldPlay = false) {
            if (currentIndex >= wordBank.length) {
                alert("¬°Incre√≠ble! Terminaste las 500 palabras.");
                return;
            }

            currentWord = wordBank[currentIndex];
            countDisplay.textContent = currentIndex + 1;
            wordInput.value = "";
            wordInput.disabled = false;
            nextBtn.classList.add('hidden');
            wordInput.focus();

            loader.classList.remove('hidden');
            try {
                audioBlob = await fetchAudio(currentWord);
                if (shouldPlay && userInteracted) {
                    await playCurrentWord();
                }
            } catch (e) {
                console.error("Error cargando audio:", e);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function normalize(s) {
            return s.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function checkAnswer() {
            userInteracted = true; 
            const user = normalize(wordInput.value);
            const target = normalize(currentWord);

            if (user === target) {
                playFirecrackersSound();
                wordInput.disabled = true;
                nextBtn.classList.remove('hidden');
                currentIndex++;
            } else {
                showThumbsDown();
            }
        }

        function showThumbsDown() {
            thumbsDown.classList.add('active');
            setTimeout(() => {
                thumbsDown.classList.remove('active');
            }, 1000);
        }

        // Listeners
        playBtn.addEventListener('click', () => {
            userInteracted = true;
            if (audioBlob) playCurrentWord();
            else loadWord(true);
        });
        
        nextBtn.addEventListener('click', () => {
            userInteracted = true;
            loadWord(true);
        });
        
        wordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // Inicializar sin play autom√°tico para evitar el error del navegador
        window.onload = () => loadWord(false);

    </script>
</body>
</html>

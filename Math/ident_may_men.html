<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Actividad: Menor y Mayor Alternados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f8fafc; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .number-card {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: 700;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid #e2e8f0;
            background: white;
            color: #334155;
        }

        .number-card.selected-correct {
            background-color: #4ade80;
            border-color: #16a34a;
            color: white;
            transform: scale(0.95);
        }

        .number-card.selected-wrong {
            background-color: #f87171;
            border-color: #dc2626;
            color: white;
        }

        .missed-correct {
            border-color: #4ade80;
            animation: pulse-green 1s infinite alternate;
        }

        @keyframes pulse-green {
            from { border-width: 4px; box-shadow: 0 0 0px rgba(74, 222, 128, 0); }
            to { border-width: 6px; box-shadow: 0 0 15px rgba(74, 222, 128, 0.5); }
        }

        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            z-index: 50;
        }

        #next-btn {
            background-color: #6366f1;
            box-shadow: 0 6px 0 #4338ca;
            transition: all 0.1s;
        }

        #next-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #4338ca;
        }
    </style>
</head>
<body class="pb-32">

    <div class="max-w-md mx-auto p-4">
        <!-- Indicadores Superiores -->
        <div class="flex justify-between items-center mb-6">
            <div class="bg-indigo-600 text-white px-5 py-2 rounded-2xl font-bold shadow-md">
                NIVEL <span id="level">1</span>/22
            </div>
            <div class="flex gap-3">
                <div class="bg-green-100 text-green-700 px-4 py-2 rounded-xl font-bold border border-green-200">‚úì <span id="hits">0</span></div>
                <div class="bg-red-100 text-red-700 px-4 py-2 rounded-xl font-bold border border-red-200">‚úó <span id="errors">0</span></div>
            </div>
        </div>

        <!-- Instrucci√≥n Central -->
        <div class="bg-white rounded-[40px] p-8 mb-6 shadow-xl shadow-indigo-100/50 text-center relative border-2 border-slate-50">
            <button id="play-audio" class="absolute top-4 right-4 p-3 bg-indigo-50 rounded-full text-indigo-600 active:scale-90 transition-transform shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
            </button>
            <h2 id="instruction-type" class="text-4xl font-black mb-2 transition-colors duration-500 uppercase tracking-tight">Cargando...</h2>
            <p class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em] mb-4">que el n√∫mero</p>
            <div id="reference-number" class="text-8xl font-black text-indigo-600 drop-shadow-sm transition-all duration-300">0</div>
        </div>

        <!-- Cuadr√≠cula de Juego -->
        <div id="grid" class="grid grid-cols-4 gap-4"></div>
    </div>

    <!-- Bot√≥n de Acci√≥n -->
    <div class="action-bar">
        <button id="next-btn" class="w-full max-w-sm text-white font-black py-5 rounded-3xl text-xl uppercase flex items-center justify-center gap-3">
            <span>Siguiente</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        </button>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;
        let currentLevel = 1;
        let totalHits = 0;
        let totalErrors = 0;
        let referenceNum = 0;
        let condition = 'less';
        let levelData = [];

        // L√≥gica de Voz Optimizada para iOS Safari
        function loadVoices() {
            voices = synth.getVoices();
            
            // Filtros para espa√±ol (prioriza iOS names)
            const spanishVoices = voices.filter(v => v.lang.includes('es'));
            
            // 1. Intentar encontrar nombres espec√≠ficos infantiles o femeninos claros
            const preferredNames = ['sofia', 'sandra', 'paulina', 'monica', 'child', 'ni√±a', 'femenina', 'female'];
            
            selectedVoice = spanishVoices.find(v => {
                const name = v.name.toLowerCase();
                return preferredNames.some(pref => name.includes(pref));
            });

            // 2. Si no hay preferida, buscar la de M√©xico por defecto
            if (!selectedVoice) {
                selectedVoice = spanishVoices.find(v => v.lang === 'es-MX') || 
                                 spanishVoices.find(v => v.lang.startsWith('es')) || 
                                 null;
            }
        }

        // Gesti√≥n As√≠ncrona obligatoria para Safari
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function speak() {
            if (!synth) return;
            
            // Cancelar cualquier locuci√≥n previa
            synth.cancel();

            const textToSpeak = `${condition === 'less' ? 'Menores' : 'Mayores'} que ${referenceNum}`;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Par√°metros de optimizaci√≥n solicitados
            utterance.lang = 'es-MX';
            utterance.rate = 0.9;   // Ligeramente m√°s lento
            utterance.pitch = 1.2;  // Tono m√°s agudo/infantil
            utterance.volume = 1.0;

            synth.speak(utterance);
        }

        const grid = document.getElementById('grid');
        const nextBtn = document.getElementById('next-btn');
        const levelSpan = document.getElementById('level');
        const hitsSpan = document.getElementById('hits');
        const errorsSpan = document.getElementById('errors');
        const instructionType = document.getElementById('instruction-type');
        const referenceText = document.getElementById('reference-number');
        const audioBtn = document.getElementById('play-audio');

        audioBtn.onclick = speak;

        function initLevel() {
            grid.innerHTML = '';
            levelData = [];
            
            // Alternar Menores (Impares) y Mayores (Pares)
            if (currentLevel % 2 !== 0) {
                condition = 'less';
                instructionType.innerText = 'MENORES';
                instructionType.style.color = '#2563eb';
            } else {
                condition = 'more';
                instructionType.innerText = 'MAYORES';
                instructionType.style.color = '#f97316';
            }
            
            const maxRange = currentLevel <= 10 ? 15 : (currentLevel <= 18 ? 30 : 50);
            
            if (condition === 'less') {
                referenceNum = Math.floor(Math.random() * (maxRange - 4)) + 4;
            } else {
                referenceNum = Math.floor(Math.random() * (maxRange / 2)) + 2;
            }

            referenceText.innerText = referenceNum;
            levelSpan.innerText = currentLevel;

            let numbers = [];
            while(numbers.length < 8) {
                let n = Math.floor(Math.random() * (maxRange + 10));
                if(n !== referenceNum && !numbers.includes(n)) numbers.push(n);
            }

            // Asegurar que haya respuestas correctas
            let validTargets = numbers.filter(n => condition === 'less' ? n < referenceNum : n > referenceNum);
            if (validTargets.length < 2) return initLevel();

            numbers.forEach(n => {
                const isTarget = condition === 'less' ? n < referenceNum : n > referenceNum;
                const card = document.createElement('div');
                card.className = 'number-card shadow-sm';
                card.innerText = n;
                
                const item = { value: n, isTarget, selected: false, element: card };
                
                card.onclick = () => {
                    item.selected = !item.selected;
                    if(item.selected) {
                        card.classList.add(isTarget ? 'selected-correct' : 'selected-wrong');
                        if(isTarget) totalHits++; else totalErrors++;
                    } else {
                        card.classList.remove('selected-correct', 'selected-wrong');
                        if(isTarget) totalHits--; else totalErrors--;
                    }
                    hitsSpan.innerText = totalHits;
                    errorsSpan.innerText = totalErrors;
                };

                levelData.push(item);
                grid.appendChild(card);
            });

            // Retraso peque√±o para que cargue la vista antes de hablar
            setTimeout(speak, 400);
        }

        nextBtn.onclick = () => {
            let missed = false;
            levelData.forEach(item => {
                if(item.isTarget && !item.selected) {
                    missed = true;
                    item.element.classList.add('missed-correct');
                    totalErrors++;
                }
            });

            if(missed) {
                errorsSpan.innerText = totalErrors;
                nextBtn.disabled = true;
                setTimeout(() => {
                    nextBtn.disabled = false;
                    goToNextLevel();
                }, 1000);
            } else {
                goToNextLevel();
            }
        };

        function goToNextLevel() {
            if(currentLevel < 22) {
                currentLevel++;
                initLevel();
            } else {
                showFinalScreen();
            }
        }

        function showFinalScreen() {
            document.body.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 bg-indigo-700 text-white text-center">
                    <div class="bg-white p-10 rounded-[48px] w-full max-w-sm text-slate-800 shadow-2xl">
                        <div class="text-7xl mb-6">ü•≥</div>
                        <h1 class="text-4xl font-black mb-1 uppercase">¬°Felicidades!</h1>
                        <p class="text-slate-400 font-bold text-sm mb-10 tracking-[0.2em]">HAS COMPLETADO EL RETO</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-10">
                            <div class="bg-green-50 p-5 rounded-3xl border border-green-100">
                                <p class="text-[10px] font-black text-green-600 mb-1 uppercase">Aciertos</p>
                                <p class="text-4xl font-black">${totalHits}</p>
                            </div>
                            <div class="bg-red-50 p-5 rounded-3xl border border-red-100">
                                <p class="text-[10px] font-black text-red-600 mb-1 uppercase">Errores</p>
                                <p class="text-4xl font-black">${totalErrors}</p>
                            </div>
                        </div>

                        <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-black py-6 rounded-[32px] shadow-lg shadow-indigo-200 active:scale-95 transition-transform uppercase text-xl">
                            Volver a Jugar
                        </button>
                    </div>
                </div>
            `;
        }

        // Primer inicio requiere interacci√≥n del usuario para habilitar audio en iOS
        document.addEventListener('click', () => {
            if (synth.state === 'suspended') {
                synth.resume();
            }
        }, { once: true });

        window.onload = initLevel;
    </script>
</body>
</html>

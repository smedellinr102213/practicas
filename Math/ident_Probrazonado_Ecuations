<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWEA Math - Problemas Razonados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #f0f4f8; 
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .math-card {
            width: 100%;
            max-width: 850px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid #d1d5db;
            overflow: hidden;
        }

        .equation-btn {
            background: #ffffff;
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            font-size: 2.25rem;
            font-weight: 800;
            color: #1f2937;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .equation-btn:active {
            transform: scale(0.95);
        }

        .equation-btn.correct {
            border-color: #10b981 !important;
            background-color: #ecfdf5 !important;
            color: #065f46;
        }

        .equation-btn.wrong {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            color: #991b1b;
        }

        #playAudio {
            transition: transform 0.2s;
            touch-action: manipulation;
        }

        #playAudio:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body>

    <div class="math-card">
        <div class="bg-indigo-700 p-5 flex justify-between items-center text-white">
            <div>
                <h1 class="text-lg font-black uppercase tracking-widest">NWEA Math Practice</h1>
                <p class="text-indigo-200 text-xs">Problemas razonados y ecuaciones</p>
            </div>
            <div class="bg-indigo-900/50 px-5 py-2 rounded-full font-black border border-indigo-400" id="counter">
                1 / 13
            </div>
        </div>

        <div id="quiz-container" class="p-8 md:p-12">
            <div class="mb-10 text-center">
                <button id="playAudio" class="group relative inline-flex items-center justify-center p-8 bg-indigo-600 rounded-full text-white shadow-2xl hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <h2 class="text-xl md:text-2xl font-bold text-slate-700 mt-2">Escucha la historia y elige la oraciÃ³n correcta.</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="optionsGrid"></div>

            <div class="mt-12 text-center">
                <button id="nextBtn" class="hidden bg-slate-900 text-white px-16 py-4 rounded-2xl font-black text-xl shadow-xl">
                    CONTINUAR â†’
                </button>
            </div>
        </div>

        <div id="results" class="hidden p-20 text-center">
            <div class="text-7xl mb-6">ðŸŽ¯</div>
            <h2 class="text-5xl font-black text-slate-800 mb-2">Â¡MisiÃ³n Cumplida!</h2>
            <div class="text-8xl font-black text-indigo-600 mb-12" id="finalScore">13 / 13</div>
            <button onclick="location.reload()" class="bg-indigo-600 text-white px-12 py-5 rounded-2xl font-black text-2xl shadow-xl">
                INTENTAR DE NUEVO
            </button>
        </div>
    </div>

    <script>
        const problems = [
            { story: "HabÃ­a 5 pÃ¡jaros en un Ã¡rbol. Luego llegaron 3 pÃ¡jaros mÃ¡s. Â¿QuÃ© oraciÃ³n muestra cuÃ¡ntos pÃ¡jaros hay ahora?", ans: "5 + 3 = 8", opts: ["5 + 3 = 8", "5 - 3 = 2", "3 + 3 = 6", "8 - 5 = 3"] },
            { story: "MarÃ­a tenÃ­a 10 manzanas. Se comiÃ³ 4 manzanas. Â¿QuÃ© oraciÃ³n muestra cuÃ¡ntas manzanas le quedan?", ans: "10 - 4 = 6", opts: ["10 + 4 = 14", "4 + 6 = 10", "10 - 4 = 6", "10 - 10 = 0"] },
            { story: "En una pecera hay 2 peces naranjas y 7 peces azules. Â¿QuÃ© oraciÃ³n muestra cuÃ¡ntos peces hay en total?", ans: "2 + 7 = 9", opts: ["7 - 2 = 5", "2 + 7 = 9", "9 - 2 = 7", "2 + 2 = 4"] },
            { story: "Juan tiene 8 canicas. PerdiÃ³ 3 canicas en el parque. Â¿QuÃ© oraciÃ³n muestra cuÃ¡ntas tiene ahora?", ans: "8 - 3 = 5", opts: ["8 + 3 = 11", "5 + 3 = 8", "8 - 3 = 5", "3 - 3 = 0"] },
            { story: "HabÃ­a 4 ranas en el lodo. Saltaron 4 ranas mÃ¡s. Â¿QuÃ© oraciÃ³n muestra el total de ranas?", ans: "4 + 4 = 8", opts: ["4 - 4 = 0", "4 + 4 = 8", "8 - 4 = 4", "4 + 1 = 5"] },
            { story: "Tengo 6 lÃ¡pices amarillos y 4 lÃ¡pices rojos. Â¿CuÃ¡ntos lÃ¡pices tengo en total?", ans: "6 + 4 = 10", opts: ["6 - 4 = 2", "10 - 6 = 4", "6 + 4 = 10", "4 + 4 = 8"] },
            { story: "En el cielo habÃ­a 9 globos. Se reventaron 2 globos. Â¿QuÃ© oraciÃ³n muestra los que quedaron?", ans: "9 - 2 = 7", opts: ["9 + 2 = 11", "9 - 2 = 7", "7 + 2 = 9", "9 - 9 = 0"] },
            { story: "Ana comprÃ³ 3 flores rosas y 3 flores blancas. Â¿CuÃ¡ntas flores tiene Ana?", ans: "3 + 3 = 6", opts: ["3 - 3 = 0", "6 - 3 = 3", "3 + 3 = 6", "3 + 1 = 4"] },
            { story: "HabÃ­a 7 galletas en un plato. Carlos se comiÃ³ una. Â¿CuÃ¡ntas galletas quedan?", ans: "7 - 1 = 6", opts: ["7 + 1 = 8", "7 - 1 = 6", "6 + 1 = 7", "1 - 1 = 0"] },
            { story: "En un nido hay 5 huevos. Nacieron 2 pollitos. Â¿CuÃ¡ntos pollitos hay en el nido?", ans: "5 + 2 = 7", opts: ["5 - 2 = 3", "5 + 2 = 7", "7 - 5 = 2", "5 + 5 = 10"] },
            { story: "HabÃ­a 4 gatos durmiendo. Se despertaron 2 y se fueron. Â¿QuÃ© oraciÃ³n muestra cuÃ¡ntos gatos duermen?", ans: "4 - 2 = 2", opts: ["4 + 2 = 6", "4 - 2 = 2", "2 + 2 = 4", "4 - 4 = 0"] },
            { story: "Tengo 8 dulces. Mi amigo me dio 2 dulces mÃ¡s. Â¿CuÃ¡ntos dulces tengo ahora?", ans: "8 + 2 = 10", opts: ["8 - 2 = 6", "10 - 2 = 8", "8 + 2 = 10", "8 + 8 = 16"] },
            { story: "En una rama hay 6 mariposas. 3 mariposas volaron lejos. Â¿CuÃ¡ntas quedaron?", ans: "6 - 3 = 3", opts: ["6 + 3 = 9", "3 + 3 = 6", "6 - 3 = 3", "6 - 6 = 0"] }
        ];

        let currentIdx = 0;
        let score = 0;
        let canInteract = true;
        let voices = [];

        // LÃ³gica de carga de voces optimizada para Safari/iOS
        function initVoices() {
            voices = window.speechSynthesis.getVoices();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }

        function getBestVoice() {
            const allVoices = window.speechSynthesis.getVoices();
            // Prioridad: Femenina/Infantil en EspaÃ±ol
            const prioritized = allVoices.find(v => 
                (v.lang.startsWith('es')) && 
                (v.name.includes('SofÃ­a') || v.name.includes('Sandra') || v.name.includes('Monica') || v.name.includes('Paulina') || v.name.includes('Femenina') || v.name.includes('Female'))
            );
            
            // Segunda opciÃ³n: Cualquier voz en espaÃ±ol (preferiblemente es-MX)
            const fallback = allVoices.find(v => v.lang === 'es-MX') || allVoices.find(v => v.lang.startsWith('es'));
            
            return prioritized || fallback || null;
        }

        function speak(text) {
            // Cancelar cualquier audio previo para evitar solapamiento en iOS
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = getBestVoice();
            
            if (voice) utterance.voice = voice;
            
            utterance.lang = 'es-MX';
            utterance.rate = 0.9;  // Velocidad optimizada
            utterance.pitch = 1.2; // Tono mÃ¡s agudo/infantil
            
            window.speechSynthesis.speak(utterance);
        }

        function loadProblem() {
            const p = problems[currentIdx];
            canInteract = true;
            document.getElementById('counter').innerText = `${currentIdx + 1} / 13`;
            document.getElementById('nextBtn').classList.add('hidden');
            
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';

            p.opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'equation-btn';
                btn.innerText = opt;
                btn.onclick = () => check(opt, btn);
                grid.appendChild(btn);
            });

            // En iOS Safari, el primer audio debe ser activado por el usuario explÃ­citamente.
            // Las siguientes pueden ser automÃ¡ticas si estÃ¡n dentro de un evento de click previo.
            if(currentIdx > 0) speak(p.story);
        }

        function check(selected, element) {
            if (!canInteract) return;
            canInteract = false;

            const isCorrect = selected === problems[currentIdx].ans;
            if (isCorrect) {
                element.classList.add('correct');
                score++;
            } else {
                element.classList.add('wrong');
                Array.from(document.getElementsByClassName('equation-btn')).forEach(b => {
                    if (b.innerText === problems[currentIdx].ans) b.classList.add('correct');
                });
            }
            document.getElementById('nextBtn').classList.remove('hidden');
        }

        document.getElementById('playAudio').onclick = () => speak(problems[currentIdx].story);
        
        document.getElementById('nextBtn').onclick = () => {
            currentIdx++;
            if (currentIdx < problems.length) loadProblem();
            else {
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('finalScore').innerText = `${score} / 13`;
            }
        };

        // Inicializar carga de voces
        initVoices();
        loadProblem();
    </script>
</body>
</html>

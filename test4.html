<script>
        // --- 1. CONFIGURACIÓN DEL JUEGO (¡SUS PALABRAS!) ---
        const palabras = {
            propios: ["Lauren", "Dilan", "Mexico", "Texas", "McDonalds", "FoodTown"],
            comunes: ["libro", "mesa", "camisa", "silla", "rana", "pato"],
            noSustantivos: ["salta", "poco", "come", "grande", "risa", "La"]
        };
        
        let elementoArrastrado = null; 
        let popup = null; 
        
        // --- 2. FUNCIÓN PARA MOSTRAR EL POP-UP ---
        function crearPopup() {
            popup = document.createElement('div');
            popup.id = 'feedback-popup';
            document.body.appendChild(popup);
        }

        function mostrarPopup(tipo, mensaje) {
            if (!popup) crearPopup(); 

            popup.textContent = mensaje;
            popup.className = ''; 
            popup.classList.add('popup-' + tipo);
            popup.style.opacity = '1';

            setTimeout(() => {
                popup.style.opacity = '0';
            }, 1000);
        }
        
        // --- 3. FUNCIÓN DE DETECCIÓN DE COLISIÓN (NUEVO) ---
        // Verifica si dos elementos rectangulares se superponen.
        function detectarColision(elem1, elem2) {
            const rect1 = elem1.getBoundingClientRect();
            const rect2 = elem2.getBoundingClientRect();

            // Si hay solapamiento en X Y en Y, hay colisión.
            return rect1.left < rect2.right &&
                   rect1.right > rect2.left &&
                   rect1.top < rect2.bottom &&
                   rect1.bottom > rect2.top;
        }


        // --- 4. FUNCIONES DE ARRASTRE Y SOLTADO ---

        function drag(ev) {
            elementoArrastrado = ev.target;
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.style.backgroundColor = '#ff6961'; 
            ev.target.style.transform = 'scale(1.1)'; 
            ev.target.style.opacity = '0.7'; 
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        // --- FUNCIÓN CENTRAL DE SOLTADO ---
        function manejarDrop(draggedElement, destinoCaja) {
            const destinoTipo = destinoCaja.getAttribute('data-tipo');
            const palabraTipo = draggedElement.getAttribute('data-tipo');
            const contenedorInicial = document.getElementById('contenedor-palabras');
            
            // Restaurar estilos de arrastre
            draggedElement.style.transform = 'scale(1.0)';
            draggedElement.style.opacity = '1.0';
            draggedElement.style.position = 'static'; 
            draggedElement.style.left = '0';
            draggedElement.style.top = '0';
            draggedElement.style.margin = '8px'; // Restaurar margen para flujo normal

            // Evaluación de la palabra
            if (palabraTipo === destinoTipo) {
                // Correcto
                destinoCaja.appendChild(draggedElement);
                draggedElement.style.backgroundColor = '#a8e6cf'; 
                draggedElement.style.color = '#0e4a1a'; 
                mostrarPopup('green', '¡Correcto!'); 
            } else {
                // Incorrecto
                contenedorInicial.appendChild(draggedElement); 
                draggedElement.style.backgroundColor = '#f7f7f7'; 
                draggedElement.style.color = '#333';
                mostrarPopup('red', '¡Error!'); 
            }
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            const destinoCaja = ev.target.classList.contains('caja-destino') ? ev.target : ev.target.closest('.caja-destino');
            
            if (!destinoCaja || !draggedElement) {
                 if (draggedElement) {
                    draggedElement.style.backgroundColor = '#f7f7f7';
                    draggedElement.style.transform = 'scale(1.0)';
                    draggedElement.style.opacity = '1.0';
                 }
                 return;
            }

            manejarDrop(draggedElement, destinoCaja);
        }

        // --- 5. FUNCIONES TÁCTILES PARA IPAD (MODIFICADA: ¡SIN elementFromPoint!) ---
        
        function touchstart(ev) {
            const target = ev.target;
            if (!target.classList.contains('palabra-draggable')) return;
            ev.preventDefault();
            elementoArrastrado = target;
            elementoArrastrado.style.margin = '0'; // Remover margen temporalmente para cálculo de posición absoluta
            elementoArrastrado.style.position = 'absolute';
            elementoArrastrado.style.zIndex = '1000';
            elementoArrastrado.style.backgroundColor = '#ff6961'; 
            elementoArrastrado.style.transform = 'scale(1.1)'; 
            elementoArrastrado.style.opacity = '0.8';

            const touch = ev.touches[0];
            elementoArrastrado.style.left = touch.pageX - elementoArrastrado.offsetWidth / 2 + 'px';
            elementoArrastrado.style.top = touch.pageY - elementoArrastrado.offsetHeight / 2 + 'px';
        }

        function touchmove(ev) {
            if (!elementoArrastrado) return;
            ev.preventDefault();
            const touch = ev.touches[0];
            elementoArrastrado.style.left = touch.pageX - elementoArrastrado.offsetWidth / 2 + 'px';
            elementoArrastrado.style.top = touch.pageY - elementoArrastrado.offsetHeight / 2 + 'px';
        }

        function touchend(ev) {
            if (!elementoArrastrado) return;
            ev.preventDefault();
            
            const cajasDestino = document.querySelectorAll('.caja-destino');
            let destinoCaja = null;

            // **MÉTODO CRÍTICO DE COLISIÓN:** Iterar y verificar si el elemento arrastrado colisiona con alguna caja.
            for(let i = 0; i < cajasDestino.length; i++) {
                if (detectarColision(elementoArrastrado, cajasDestino[i])) {
                    destinoCaja = cajasDestino[i];
                    break; 
                }
            }

            if (destinoCaja) {
                // Soltado en una caja destino válida (detectada por colisión)
                manejarDrop(elementoArrastrado, destinoCaja);
            } else {
                // Soltado fuera de cualquier caja destino
                const contenedorInicial = document.getElementById('contenedor-palabras');
                contenedorInicial.appendChild(elementoArrastrado);
                mostrarPopup('red', '¡Error!');
                
                // Restaurar estilos
                elementoArrastrado.style.transform = 'scale(1.0)';
                elementoArrastrado.style.opacity = '1.0';
                elementoArrastrado.style.position = 'static'; 
                elementoArrastrado.style.margin = '8px';
                elementoArrastrado.style.backgroundColor = '#f7f7f7'; 
                elementoArrastrado.style.color = '#333';
            }

            elementoArrastrado = null; 
        }
        
        // --- 6. FUNCIÓN PARA ENLAZAR EVENTOS TÁCTILES y Inicialización ---
        function prepararEventosTactiles() {
            const palabrasDraggable = document.querySelectorAll('.palabra-draggable');
            palabrasDraggable.forEach(palabra => {
                palabra.addEventListener('touchstart', touchstart, { passive: false });
                palabra.addEventListener('touchmove', touchmove, { passive: false });
                palabra.addEventListener('touchend', touchend, { passive: false });
            });
        }

        function iniciarJuego() {
            const contenedorPalabras = document.getElementById('contenedor-palabras');
            let todasLasPalabras = [];
            
            for (const tipo in palabras) {
                palabras[tipo].forEach(palabra => {
                    todasLasPalabras.push({ texto: palabra, tipo: tipo });
                });
            }
            
            todasLasPalabras.sort(() => Math.random() - 0.5);
            
            todasLasPalabras.forEach((palabraObj, index) => {
                const p = document.createElement('p');
                p.textContent = palabraObj.texto;
                p.id = `palabra-${index}`;
                p.className = 'palabra-draggable';
                p.draggable = true;
                p.setAttribute('data-tipo', palabraObj.tipo); 
                p.setAttribute('ondragstart', 'drag(event)');
                contenedorPalabras.appendChild(p);
            });
            
            prepararEventosTactiles();
            crearPopup();
        }

        window.onload = iniciarJuego;
    </script>
